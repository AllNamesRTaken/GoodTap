class CalcConst{}function rotationRad(t){const e=t*CalcConst.DEGREE_FACTOR*CalcConst.ROTATION_DEGREE_PRECISION|0;return this.rotationDeg(e/CalcConst.ROTATION_DEGREE_PRECISION)}CalcConst.ROTATION_DEGREE_PRECISION=1,CalcConst.RADIAN_FACTOR=1/360*(2*Math.PI),CalcConst.DEGREE_FACTOR=1/(2*Math.PI)*360,CalcConst.DEG360=360*CalcConst.ROTATION_DEGREE_PRECISION,CalcConst.ROTATION_LOOKUP=function(){const t=[];for(let e=0;e<360*CalcConst.ROTATION_DEGREE_PRECISION;e++)t.push([Math.cos(e*CalcConst.RADIAN_FACTOR),Math.sin(e*CalcConst.RADIAN_FACTOR)]);return t}();class Vec2Const{}Vec2Const.EPSILON=1e-8,Vec2Const.IDENTITY={x:1,y:1},Vec2Const.X_DIM={x:1,y:0},Vec2Const.Y_DIM={x:0,y:1};class Vec2{constructor(t=0,e=0){this.angle=this.horizontalAngle,this.direction=this.horizontalAngle,this.x=t,this.y=e}get isZero(){return 0===this.x&&0===this.y}create(t=0,e=0){return new this.constructor(t,e)}set(t){return this.x=t.x,this.y=t.y,this}clone(t){return t?t.set(this):this.create(this.x,this.y)}toInt(){return this.x|=0,this.y|=0,this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}toDecimal(){return this.x+=Vec2Const.EPSILON,this.y+=Vec2Const.EPSILON,this}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.lengthSq())}horizontalAngle(){return Math.atan2(this.y,this.x)}rotate(t){const e=rotationRad(t),i=this.x*e[0]-this.y*e[1],n=this.x*e[1]+this.y*e[0];return this.x=i,this.y=n,this}rotateAround(t,e){return this.subtract(t).rotate(e).add(t)}normalize(){const t=this.length();return 0===t?(this.x=1,this.y=0):(this.x=this.x/t,this.y=this.y/t),this}scale(t){return this.x=this.x*t.x,this.y=this.y*t.y,this}relate(t){return this.x=this.x/t.x,this.y=this.y/t.y,this}multiply(t){return this.x=this.x*t,this.y=this.y*t,this}add(t){return this.x=this.x+t.x,this.y=this.y+t.y,this}subtract(t){return this.x=this.x-t.x,this.y=this.y-t.y,this}invert(){return this.x=-this.x,this.y=-this.y,this}equals(t){return this.x===t.x&&this.y===t.y}almostEquals(t){return Math.abs(this.x-t.x)<Vec2Const.EPSILON&&Math.abs(this.y-t.y)<Vec2Const.EPSILON}getNormal(t){const e=this.clone();t||e.set(this).normalize();const i=e.x;return e.x=e.y,e.y=-i,e}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}projectOnto(t){const e=(this.x*t.x+this.y*t.y)/(t.x*t.x+t.y*t.y);return this.x=e*t.x,this.y=e*t.y,this}verticalAngle(){return Math.atan2(this.x,this.y)}rotateBy(t){const e=-this.horizontalAngle()+t;return this.rotate(e)}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}zero(){return this.x=0,this.y=0,this}}let nativeWindow=!0;var win;"undefined"==typeof window?(win=null,nativeWindow=!1):win=window;class _Global{constructor(){this._window=win,this._nativeWindow=nativeWindow}get window(){return this._window}set window(t){this._window=t,this.hasNativeWindow&&(win=t)}get hasNativeWindow(){return this._nativeWindow}}let Global=new _Global;function hasWindow(){return null!==Global.window}function isArray(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)}function isFunction(t){return"[object Function]"===Object.prototype.toString.call(t)}function isNumber(t){return t===+t}function areNullOrUndefined(...t){const e=t.length;let i,n=-1,r=!1;for(;!r&&++n<e;)r=void 0===(i=t[n])||null===i;return r}function areNotNullOrUndefined(...t){return!areNullOrUndefined(...t)}function isNullOrUndefined(t){return void 0===t||null===t}function isNotNullOrUndefined(t){return!isNullOrUndefined(t)}function isUndefined(t){return void 0===t}function isNotUndefined(t){return!isUndefined(t)}function wipe(t){const e=Object.keys(t);let i=-1;const n=e.length;for(;++i<n;)delete t[e[i]]}function isSameClass(t,e){return areNotNullOrUndefined(t,e)&&t.constructor===e.constructor}function equals(t,e){let i=t===e;if(t!==e&&t instanceof Object&&isSameClass(t,e))if(isArray(t)){const n=t.length;let r=0;if(i=n===e.length)for(;r<n&&!1!==(i=equals(t[r],e[r]));r+=1);}else if(t.constructor.prototype.equals)i=t.equals(e);else{const n=Object.keys(t);let r=null;i=!0;let s=-1;const h=n.length;for(;++s<h;)if(!(i=equals(t[r=n[s]],e[r]))){if(!isFunction(t[r]))break;i=!0}}return i}function clone(t){let e;if(t instanceof Object)if(void 0!==t.constructor.prototype.clone)e=t.clone();else if(isArray(t))e=deepCopy(t);else{if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t);{e=new t.constructor;const i=Object.keys(t);let n=null,r=-1;const s=i.length;for(;++r<s;)e[n=i[r]]=clone(t[n])}}else e=t;return e}function setProperties(t,e,i){const n=Object.keys(e);let r,s,h=-1;const l=n.length;for(;++h<l;)s=e[r=n[h]],i&&r in i&&(r=i[r]),r in t&&(t[r]=e[n[h]])}function reverse(t){let e=null,i=null;const n=isNullOrUndefined(t)?0:t.length;for(e=0;e<n/2;e+=1){i=n-1-e;const r=t[e];t[e]=t[i],t[i]=r}return t}function concat(...t){return Array.prototype.concat.apply([],t)}function slice(t,e=0,i=1/0){let n=Math.min(isNullOrUndefined(t)?0:t.length-e,i);n<0&&(n=0);let r=-1;const s=new Array(n);for(;++r<n;)s[r]=t[r+e];return s}function splice(t,e=0,i=1/0,n=[]){if(isNullOrUndefined(t))throw new Error("Unable to splice on null or undefined");let r=t.length;e=Math.max(0,e),e=Math.min(e,r),i=Math.max(0,i),i=Math.min(i,r-e);let s=n.length,h=r-i+s,l=i-s;if(l<0){t.length=h;let n=h;for(;--n>=e+i;)t[n]=t[n+l]}let o=e-1;for(;++o<e+s;)t[o]=n[o-e];if(l>0){for(--o;++o<r-l;)t[o]=t[o+l];t.length=h}}function append(t,e){let i=-1;const n=t.length,r=isNullOrUndefined(e)?0:e.length;for(;++i<r;)t[n+i]=e[i]}function removeAt(t,e){let i,n=isNullOrUndefined(t)?0:t.length;if(e>=0&&e<n){let r=e;for(i=t[e];++r<n;)t[r-1]=t[r];t.length-=1}return i}function indexOfElement(t,e){let i=-1;const n=isNullOrUndefined(t)?0:t.length;for(;++i<n;)if(t[i]===e)return i;return-1}function remove(t,e){removeAt(t,indexOfElement(t,e))}function indexOf(t,e){let i=-1;const n=isNullOrUndefined(t)?0:t.length;for(;++i<n;)if(e(t[i]))return i;return-1}function shallowCopy$1(t){let e=-1;const i=isNullOrUndefined(t)?0:t.length,n=new Array(i);for(;++e<i;)n[e]=t[e];return n}function shallowCopyInto(t,e){let i=-1;const n=isNullOrUndefined(t)?0:t.length;for(e.length=n;++i<n;)e[i]=t[i]}function deepCopy(t){let e=-1;const i=isNullOrUndefined(t)?0:t.length,n=new Array(i);for(;++e<i;)n[e]=clone(t[e]);return n}function deepCopyInto(t,e){let i=-1;const n=isNullOrUndefined(t)?0:t.length;for(e.length=n;++i<n;)e[i]=clone(t[i])}function filter(t,e){const i=[];let n=-1;const r=isNullOrUndefined(t)?0:t.length;for(;++n<r;){const r=t[n];!0===e(r,n)&&i.push(r)}return i}function filterInto(t,e,i){let n=-1,r=0;const s=isNullOrUndefined(t)?0:t.length,h=e.length;for(;++n<s;){const s=t[n];!0===i(s,n)&&(r<h?e[r++]=s:(++r,e.push(s)))}e.length=r}function map(t,e){let i=-1;const n=isNullOrUndefined(t)?0:t.length,r=new Array(n);for(;++i<n;)r[i]=e(t[i],i);return r}function mapInto(t,e,i){let n=-1;const r=isNullOrUndefined(t)?0:t.length;for(e.length=r;++n<r;)e[n]=i(t[n],n)}function reduce(t,e,i){let n=-1;const r=isNullOrUndefined(t)?0:t.length;let s=i;for(;++n<r;)s=e(s,t[n]);return s}function reduceUntil(t,e,i,n){let r=-1;const s=isNullOrUndefined(t)?0:t.length;let h=n;for(;++r<s&&!i(h,t[r]);)h=e(h,t[r]);return h}function reverseReduce(t,e,i){let n=isNullOrUndefined(t)?0:t.length,r=i;for(;--n>=0;)r=e(r,t[n]);return r}function reverseReduceUntil(t,e,i,n){let r=isNullOrUndefined(t)?0:t.length,s=n;for(;--r>=0&&!i(s,t[r]);)s=e(s,t[r]);return s}function forEach(t,e,i=0){let n=i-1;const r=isNullOrUndefined(t)?0:t.length;for(;++n<r;)e(t[n],n)}function forSome(t,e,i){let n=-1;const r=isNullOrUndefined(t)?0:t.length;for(;++n<r;){const r=t[n];e(r,n)&&i(r,n)}}function until(t,e,i,n){let r=isUndefined(i)||isNumber(i),s=isUndefined(n=r?i:n)||n<0?-1:n-1;const h=isNullOrUndefined(t)?0:t.length;for(;++s<h&&(r?!e(t[s],s):!e(t[s],s)&&(i(t[s],s),1)););}function reverseForEach(t,e){let i=isNullOrUndefined(t)?0:t.length;for(;--i>=0;)e(t[i],i)}function reverseUntil(t,e,i){let n=isNullOrUndefined(t)?0:t.length,r=isUndefined(i);for(;--n>=0&&(r?!e(t[n],n):!e(t[n],n)&&(i(t[n],n),1)););}function some(t,e){let i=!1,n=-1;const r=isNullOrUndefined(t)?0:t.length;for(;++n<r&&!(i=e(t[n])););return i}function all(t,e){let i=!0,n=-1;const r=isNullOrUndefined(t)?0:t.length;for(;++n<r&&(i=e(t[n])););return i}function insertAt(t,e,i){if(isNullOrUndefined(t))throw new Error("Unable to insertAt on null or undefined");if(0===e)t.unshift(i);else if(e>0){let n=t.length;for(;--n>=e;)t[n+1]=t[n];t[n+1]=i}}function create(t,e){(t||-1)<0&&(t=0);let i=new Array(t),n=-1;for(;++n<t;)i[n]=e(n,i);return i}function deserialize(t,e,...i){let[n,...r]=i;return isNotUndefined(n)?isNotUndefined(n.prototype.deserialize)?mapInto(t,e,t=>(new n).deserialize(t,...r)):mapInto(t,e,t=>{let e=new n;return setProperties(e,t),e}):deepCopyInto(t,e),this}class Dictionary{constructor(){this._lookup=Object.create(null),this._list=new List,this._isDirty=!1}create(){return new this.constructor}has(t){return void 0!==this._lookup[t]}contains(t){return this.has(t)}get(t){return this._lookup[t]}set(t,e){return this._isDirty=this._isDirty||this.has(t),void 0!==e&&(this._lookup[t]=e,this._isDirty||this._list.push(e)),this}delete(t){return this.has(t)&&(delete this._lookup[t],this._isDirty=!0),this}clear(){return wipe(this._lookup),this._list.clear(),this}get values(){return this.cleanList(),this._list.values}get keys(){return Object.keys(this._lookup)}get list(){return this.cleanList(),this._list}get count(){let t=0;return t=this._isDirty?this.keys.length:this._list.count}cleanList(){this._isDirty&&this.reCreateList()}reCreateList(){let t=this._lookup,e=Object.keys(this._lookup),i=-1,n=this._list;for(n.clear();++i<e.length;)n.add(t[e[i]])}clone(){let t=this.create();return t._isDirty=this._isDirty,t._list=this._list.clone(),t._lookup=clone(this._lookup),t}toJSON(){return this._lookup}serialize(){let t=Object.create(null);return forEach(this.keys,e=>{let i=this.get(e);t[e]=isFunction(i.serialize)?i.serialize():i}),t}deserialize(t,...e){let[i,...n]=e;if(this.clear(),isNotUndefined(i))if(isNotUndefined(i.prototype.deserialize))for(let e of Object.keys(t))this.set(e,(new i).deserialize(t[e],...n));else for(let e of Object.keys(t)){let n=new i;setProperties(n,t[e]),this.set(e,n)}else for(let e of Object.keys(t))this.set(e,t[e]);return this}}hasWindow()&&!window.Symbol&&(window.Symbol={iterator:"iterator"});class List{constructor(t){this._array=[],this._index=null,this._indexer=null,this._pointer=0,this._array=void 0===t?new Array:shallowCopy$1(t instanceof List?t._array:t)}[Symbol.iterator](){return this}next(t){return{done:this._pointer>=this.length,value:this._pointer<this.length?this._array[this._pointer++]:void(this._pointer=0)}}create(t){return new this.constructor(t)}get values(){return this._array}get(t){return this._array[t]}getByIndex(t){return isNotNullOrUndefined(this._index)?this._index.get(t):void 0}set(t,e){if(!(t>=0&&t<this.length))throw new Error(`index out of bounds on <List>.set(${t}, ${e.toString()})`);return this._array[0|t]=e,null!==this._indexer&&this._index.set(this._indexer(e),e),this}get count(){return this._array.length}get length(){return this._array.length}get indexer(){return this._indexer}set indexer(t){this._indexer=t,this._reindex()}_reindex(){null===this._indexer?this._index=null:(null===this._index?this._index=new Dictionary:this._index.clear(),this.forEach(t=>this._index.set(this._indexer(t),t)))}truncate(t=0){if(t<0){let e=this._array,i=e.length,n=i-(t=Math.min(i,-1*t))-1,r=-1;for(;++n<i;)e[++r]=e[n]}return this._array.length=Math.max(0,Math.min(this._array.length,t)),this._reindex(),this}fill(t,e){return t=Math.max(0,t||0),isFunction(e)?this._array=create(t,e):e instanceof Object?this._array=create(t,()=>clone(e)):this._array=create(t,()=>e),this._reindex(),this}clear(){return this._array.length=0,null!==this._index&&this._index.clear(),this}add(t){return this._array.push(t),null!==this._indexer&&this._index.set(this._indexer(t),t),this}insertAt(t,e){return insertAt(this._array,t,e),null!==this._indexer&&this._index.set(this._indexer(e),e),this}push(t){return null!==this._indexer&&this._index.set(this._indexer(t),t),this._array.push(t)}pop(){let t=this._array.pop();return void 0!==t&&null!==this._indexer&&this._index.delete(this._indexer(t)),t}shift(){let t=this._array.shift();return void 0!==t&&null!==this._indexer&&this._index.delete(this._indexer(t)),t}concat(t){let e,i=t instanceof List?t.values:t;return e=concat(this._array,i),this.create(e)}index(t){null!==this._indexer&&forEach(t,t=>{this._index.set(this._indexer(t),t)})}unindexEl(t){null!==this._indexer&&this._index.delete(this._indexer(t))}append(t){let e=t instanceof List?t.values:t;return append(this._array,e),this.index(e),this}copy(t){let e=t instanceof List?t.values:t;return deepCopyInto(e,this._array),this.index(e),this}shallowCopy(t){let e=t instanceof List?t.values:t;return shallowCopyInto(e,this._array),this.index(e),this}clone(){const t=deepCopy(this._array);let e=this.create(t);return null!==this._indexer&&(e._indexer=this._indexer,e._index=this._index.clone()),e}remove(t){return remove(this._array,t),this.unindexEl(t),this}removeFirst(t){let e=this.removeAt(this.indexOf(t));return this.unindexEl(e),e}removeAt(t){let e=removeAt(this._array,t);return this.unindexEl(e),e}forEach(t,e=0){return forEach(this._array,t,e),this}forSome(t,e){return forSome(this._array,t,e),this}until(t,e,i){return until(this._array,t,e,i),this}reverseForEach(t){return reverseForEach(this._array,t),this}reverseUntil(t,e){return reverseUntil(this._array,t,e),this}some(t){return some(this._array,t)}all(t){return all(this._array,t)}indexOf(t){let e=-1;return e=isFunction(t)?indexOf(this._array,t):indexOfElement(this._array,t)}contains(t){let e=!1;return e=isFunction(t)?void 0!==this.find(t):null!==this._indexer?this._index.contains(this._indexer(t)):-1!==indexOfElement(this._array,t)}reverse(){return reverse(this._array),this}first(t){let e=-1;return-1===(e=void 0===t?0:indexOf(this._array,t))?void 0:this.get(e)}find(t){return this.first(t)}last(){return 0===this.length?void 0:this.get(this.length-1)}filter(t){return this.create(filter(this._array,t))}select(t){return this.create(filter(this._array,t))}selectInto(t,e){let i=t instanceof List?t.values:t;return filterInto(i,this._array,e),this.index(i),this}head(t=1){return t=Math.max(0,t),this.create(slice(this._array,0,t))}tail(t=1){return t=Math.min(this._array.length,t),this.create(slice(this._array,Math.max(0,this._array.length-t)))}splice(t=0,e=1/0,i=[]){return splice(this._array,t,e,isArray(i)?i:i.values),this._reindex(),this}orderBy(t){return this._array.sort(t),this}map(t){return this.create(map(this._array,t))}mapInto(t,e){return mapInto(t instanceof List?t.values:t,this._array,e),this._reindex(),this}reduce(t,e){return reduce(this._array,t,e)}reduceUntil(t,e,i){return reduceUntil(this._array,t,e,i)}reverseReduce(t,e){return reverseReduce(this._array,t,e)}reverseReduceUntil(t,e,i){return reverseReduceUntil(this._array,t,e,i)}equals(t){return equals(this._array,t.values)}same(t){let e=this,i=0;return e.length===t.length&&(null!==e.indexer?t.until(t=>!e.contains(t),(t,e)=>++i):e.until(e=>!t.contains(e),(t,e)=>++i)),i===e.length}intersect(t){let e,i,n=this.create();return n.indexer=this.indexer,this.length<t.length?(i=this,e=t):(e=this,i=t),null!==e.indexer?i.forEach(t=>{e.contains(t)&&n.push(t)}):e.forEach(t=>{i.contains(t)&&n.push(t)}),n}union(t){let e,i,n=this.create();return n.indexer=this.indexer,this.length<t.length?(i=this,e=t):(e=this,i=t),null!==e.indexer?(n=e.clone(),i.forEach(t=>{e.contains(t)||n.push(t)})):(n=i.clone(),e.forEach(t=>{i.contains(t)||n.push(t)})),n}subtract(t){let e=this.create();return e.indexer=this.indexer,e=this.select(e=>!t.contains(e))}zip(t,e=((t,e)=>[t,e])){let i=this.create(),n=t.length;return this.until(function(t,e){return e>=n},function(n,r){i.push(e(n,t.get(r)))}),i}unzip(t=(t=>[t[0],t[1]])){let e=[this.create(),this.create()];return this.forEach(function(i){let n=t(i);e[0].push(n[0]),e[1].push(n[1])}),e}flatten(t=1/0){return this.create(t<1?this.values:this._flattenInner(this.values,t))}_flattenInner(t,e,i=-1,n=[]){let r=-1;const s=t.length;if(++i>e)n.push(t);else for(;++r<s;)isArray(t[r])?this._flattenInner(t[r],e,i,n):t[r]instanceof List?this._flattenInner(t[r].values,e,i,n):n.push(t[r]);return n}toJSON(){return this.values}serialize(){return this.values.map(t=>isFunction(t.serialize)?t.serialize():t)}deserialize(t,...e){return deserialize(t,this._array,...e),this}}hasWindow()&&!window.Symbol&&(window.Symbol={iterator:"iterator"});class Stack{constructor(t){this.DEFAULT_SIZE=100,this._pos=0,this._limit=0,t||(t=this.DEFAULT_SIZE),this.DEFAULT_SIZE=t,this._array=new Array(t),this.push=this.fastPush}get values(){return slice(this._array,0,this._pos)}get depth(){return this._pos}get size(){return this._pos}get isEmpty(){return 0===this.size}get limit(){return this._limit}set limit(t){t<0&&(t=0),this._limit=t,0===t?this.push=this.fastPush:(this.push=this.limitedPush,this.limitObjects())}create(t){return new this.constructor(t)}push(t){}fastPush(t){this._array[this._pos++]=t}limitedPush(t){this._array[this._pos]=t,++this._pos,this.limitObjects()}pop(){let t=void 0;return 0!==this._pos&&(t=this._array[--this._pos]),t}peek(){return this._array[this._pos-1]}peekAt(t){return t<0||t>=this._pos?void 0:this._array[this._pos-t-1]}toList(){new List;return new List(this.values)}clear(){return this._pos=0,this._array.length=this.DEFAULT_SIZE,this}clone(){const t=deepCopy(this._array);let e=this.create(this.DEFAULT_SIZE);return e._array=t,e._limit=this._limit,e._pos=this._pos,e}limitObjects(){for(;this._pos>this._limit;)this._array.shift(),--this._pos}toJSON(){return slice(this.values,0,this._pos)}serialize(){return slice(this.values,0,this._pos).map(t=>isFunction(t.serialize)?t.serialize():t)}deserialize(t,...e){return deserialize(t,this._array,...e),this._pos=t.length,this}}function Initable(t){return class extends t{init(t,e){return setProperties(this,t,e),this}}}class TimerState{}TimerState._hasPerformance="undefined"!=typeof performance;class Timer{static get time(){return TimerState._time}static now(){if(TimerState._hasPerformance)return performance.now();{const t=process.hrtime();return 1e3*t[0]+t[1]/1e6}}static start(){const t=Timer.now();return TimerState._start=TimerState._last=t,TimerState._time=0}static stop(){const t=TimerState._start,e=Timer.now();return TimerState._last=e,TimerState._time=e-t}}function newUUID(){let t=(new Date).getTime();return t+=Timer.now(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)})}var __decorate=function(t,e,i,n){var r,s=arguments.length,h=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(t,e,i,n);else for(var l=t.length-1;l>=0;l--)(r=t[l])&&(h=(s<3?r(h):s>3?r(e,i,h):r(e,i))||h);return s>3&&h&&Object.defineProperty(e,i,h),h},__metadata=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let Tree=Tree_1=class{constructor(t){this.id="",this.parent=null,this.children=null,this.data=null,this.virtual=!1,this.id=isNullOrUndefined(t)?newUUID():t}static fromObject(t){const e=this instanceof Tree_1?this:null,i=new Tree_1(t.id).init({data:t.data,parent:e});return void 0!==t.children&&isArray(t.children)&&(i.children=new List(map(t.children,Tree_1.fromObject.bind(i)))),i}static fromNodeList(t,e,i=!1,n=Tree_1){let r=new Tree_1,s=t=>e&&void 0!==e[t]?"string"==typeof e[t]?i=>i[e[t]]:e[t]:e=>e[t],h={id:s("id"),parent:s("parent"),data:s("data")},l=new List(t),o=new Dictionary,a=l.map(t=>(new n).init({id:h.id(t),data:h.data(t)}));a.forEach((t,e)=>{o.has(t.id)||o.set(t.id,[]),o.get(t.id).push(t)});let u=new List;return l.forEach((t,e)=>{let i=h.parent(t);h.id(t);o.contains(i)?o.get(i).forEach(t=>t.add(a.get(e))):u.add(a.get(e))}),!1===i?r=u.first():(r=(new n).init({virtual:!0}),u.forEach(t=>r.add(t))),r}get root(){let t=this;for(;t.parent;)t=t.parent;return t}create(...t){return new this.constructor(...t)}init(t){return setProperties(this,t),this}insertAt(t,e,i){let n;return null===this.children||this.children.count<=t?n=this.add(e):(e instanceof Tree_1?(n=e,e.parent=this):n=this.create(i).init({data:e,parent:this}),this.children.insertAt(t,n)),n}add(t,e){let i;return null===this.children&&(this.children=new List),isSameClass(t,this)?((i=t).parent=this,this.children.add(i)):(i=this.create(e).init({data:t,parent:this}),this.children.add(i)),i}remove(){null!==this.parent&&this.parent.children.remove(this)}prune(){return null!==this.children&&this.children.forEach(function(t,e){t.parent=null}).clear(),this.children=null,this}cut(){return this.remove(),this.parent=null,this}forEach(t,e=0){return t(this,e),this.children&&this.children.forEach(e=>e.forEach(t)),this}reduce(t,e){const i=new Stack;let n,r,s=e;for(t||(t=((t,e)=>(t.push({id:e.id,parent:e.parent?e.parent.id:null,data:e.data}),t))),void 0===e&&(s=[]),i.push(this);n=i.pop();)for(s=t(s,n),r=n.children&&n.children.count||0;r--;)i.push(n.children.get(r));return s}clone(){const t=this.create();return t.id=this.id,t.children=null===this.children?null:this.children.clone(),null!==t.children&&t.children.forEach(e=>e.parent=t),t.data=null===this.data||void 0===this.data?this.data:clone(this.data),t}duplicateNode(){const t=this.create();return t.id=this.id,t.data=this.data,t}filter(t,e=null){let i=null;if(t(this)){i=this.duplicateNode();const n=this.children;i.parent=e,null!==n&&(i.children=n.select(t).map(function(e,n){return e.filter(t,i)}))}return i}select(t,e=new List){const i=e,n=this.children;return(void 0===t||t(this))&&i.add(this),n&&n.reduce(function(e,i){return i.select(t,e)},i),i}find(t){let e=null;if(null!==this.children){let i=-1;const n=this.children.count,r=this.children.values;for(;++i<n;){if(t(r[i])){e=r[i];break}if(null!==(e=null!==r[i].children?r[i].find(t):null))break}}return e}depth(){let t=0,e=this;for(;e.parent;)e=e.parent,++t;return t}sort(t){return null!==this.children&&(this.children.orderBy(t),this.children.forEach(e=>e.sort(t))),this}toJSON(){let t=new List;return t.push({id:this.id,data:this.data,parent:null===this.parent?null:this.parent.id,children:null===this.children?null:this.children.map(t=>t.id)}),null!==this.children&&this.children.forEach(e=>t.append(e.toJSON())),t.toJSON()}serialize(){let t=new List;return t.push({id:this.id,data:this.data,parent:null===this.parent?null:this.parent.id,children:null===this.children?null:this.children.map(t=>t.id)}),null!==this.children&&this.children.forEach(e=>t.append(e.serialize())),t.serialize()}};var Tree_1,Sides,MocDataType;Tree=Tree_1=__decorate([Initable,__metadata("design:paramtypes",[Object])],Tree),function(t){t[t.Top=0]="Top",t[t.Bottom=1]="Bottom",t[t.Left=2]="Left",t[t.Right=3]="Right"}(Sides||(Sides={}));class DomState{}function toArray$1(t){return Array.prototype.slice.call(t)}function findAll(t,e){return toArray$1((e||DomState._document).querySelectorAll(t))}function is(t,e){let i=!1;if(e.matches)i=e.matches(t);else if(e.msMatchesSelector)i=e.msMatchesSelector(t);else if(e.webkitMatchesSelector)i=e.webkitMatchesSelector(t);else{if(null===e.parentElement)throw new Error("Element has no parent");i=""!==e.id?null!==e.parentElement.querySelector("#"+e.id):-1!==toArray$1(e.parentElement.querySelectorAll(t)).indexOf(e)}return i}DomState.Sides=Sides,DomState._window=Global.window,DomState._document=Global.window?Global.window.document:void 0,DomState._el=Global.window?Global.window.document.createElement("div"):void 0,function(t){t[t.LinearInt=0]="LinearInt",t[t.RandomInt=1]="RandomInt",t[t.LinearFloat=2]="LinearFloat",t[t.RandomFloat=3]="RandomFloat"}(MocDataType||(MocDataType={}));let VERSION="0.1.0";class GoodTap{constructor(t){this.version=VERSION,this.minSwipeDistance=100,this.maxTapDuration=400,this.defaultLongPressDuration=400,this.defaultDragResistance=0,this.dragResistanceSquared=0,this.events=["down","drag","up","press","tap","swipe"],this.downEvents=["down"],this.upEvents=["up","tap","swipe"],this.longPressIntervals=new Dictionary,this.eventAttr="",this.upEventsAndPress=[],this.index=0,this.lastInsides=new List,this.dragging=new List,this.isListeningToMovement=!1,this.init(t||document.body),this.eventAttr=this.events.map(t=>"["+t+"]").join(","),this.upEventsAndPress=[...this.upEvents,"press"]}init(t){this.hasTouchEvent()&&(t.addEventListener("touchstart",e=>{this.start(e,t)}),t.addEventListener("touchend",e=>{this.end(e,t)})),t.addEventListener("mousedown",e=>{this.start(e,t)}),t.addEventListener("mouseup",e=>{this.end(e,t)}),t.addEventListener("focus",e=>this.triggerOutside(e.target,e,t),!0),this.root=t}findTarget(t){let e=null;for(;t&&t.parentElement!==document&&null===e;)is(this.eventAttr,t)&&(e=t),t=t.parentElement;return e}findTargets(t){let e=[];for(;t&&t.parentElement!==document;)t.id||(t.id=newUUID()),is(this.eventAttr,t)&&e.push(t),t=t.parentElement;return e}getTouchPos(t,e){return e=e||new Vec2(0,0),t instanceof TouchEvent?(e.x=t.changedTouches[0].pageX,e.y=t.changedTouches[0].pageY):t instanceof MouseEvent&&(e.x=t.pageX,e.y=t.pageY),e}longPress(t,e){let i=!0,n=e.touchInfo;(!1===(i=this.executeAction(t,e,"press",n))||e.hasAttribute("once"))&&(clearInterval(this.longPressIntervals.get(n.index)),this.longPressIntervals.delete(n.index))}triggerOutside(t,e,i){let n=new List(findAll("[outside]",this.root));if(n.length>0){let i=new List(this.findTargets(t));i.contains(t=>t.hasAttribute("preventDefault"))||(n.filter(t=>this.lastInsides.contains(t)&&!i.contains(t)).forEach(t=>this.handleEvent("outside",e,t)),this.lastInsides=i)}}move(t,e,i,n){let r=!0,s=i.touchInfo;if(void 0!==s){if(this.getTouchPos(t,s.pos),0===s.dragResistance||this.getTouchPos(t).subtract(s.pos).lengthSq()<s.dragResistance){s.dragResistance=0;try{"[fn]"===n&&"drag-fn"in i?r=i["drag-fn"](t,i,s):(i["drag-fn"]=new Function("event","target","touch",n).bind(i),r=i["drag-fn"](t,i,s))}catch(t){throw name+" event function error on element '"+i.id+"'\n"+t.toString()}!1===r&&this.end(t,e)}}else this.end(t,e)}start(t,e){this.longPressIntervals.list.forEach(t=>clearInterval(t)),this.longPressIntervals.clear();let i=!1,n=t.target,r=0;for(this.triggerOutside(n,t,e);r<100&&(n=this.findTarget(n))&&!i;){++r;let s=null;n.hasAttribute("press")&&(s=setInterval((e=>this.longPress(t,e)).bind(this,n),parseInt(n.getAttribute("pressInterval"))||this.defaultLongPressDuration));let h=void 0,l=0;if(n.hasAttribute("drag")){l=parseInt(n.getAttribute("dragResistance")),isNaN(l)&&(l=this.defaultDragResistance),l*=l;let t=n.getAttribute("drag");h=((t,i,n)=>{this.move(n,e,t,i)}).bind(this,n,t),this.hasTouchEvent()&&e.addEventListener("touchmove",h),e.addEventListener("mousemove",h)}n.classList.add("gt-active"),n.touchInfo={index:this.index++,time:Timer.now(),pos:this.getTouchPos(t),long:s,moveHandler:h,dragResistance:l},s&&this.longPressIntervals.set(n.touchInfo.index,n.touchInfo.long),until(this.downEvents,e=>(n.hasAttribute(e)&&((!(i=!1===this.handleEvent(e,t,n))&&n.hasAttribute("stopPropagation")||n.hasAttribute("gt-false"))&&(i=!0,t.stopPropagation()),(n.hasAttribute("preventDefault")||n.hasAttribute("gt-false"))&&t.preventDefault()),i)),n=n.parentElement}}isSwipe(t,e){let i=this.getTouchPos(t),n=!1;if("touchInfo"in e){let t=i.x-e.touchInfo.pos.x,r=i.y-e.touchInfo.pos.y,s=Math.abs(t),h=Math.abs(r),l=s>h,o=l?s:h;(n=o>=this.minSwipeDistance)&&(e.touchInfo.swipeInfo={direction:l?t<0?"left":"right":r<0?"up":"down",distance:o,delta:new Vec2(t,r)})}return n}end(t,e){let i=Timer.now(),n=!1,r=t.target,s=0;new List;for(this.dragging.clear();s<100&&(r=this.findTarget(r))&&!n;){++s;let e=r.touchInfo;if(void 0!==e){let s=i-e.time;until(this.upEventsAndPress,e=>{if(r.hasAttribute(e)){let i=this.isSwipe(t,r);("swipe"===e&&i||"tap"===e&&!i&&s<this.maxTapDuration||"up"===e)&&(n=!1===this.handleEvent(e,t,r)),(n||r.hasAttribute("stopPropagation")||r.hasAttribute("gt-false"))&&(n=!0,t.stopPropagation(),delete r.touchInfo),(r.hasAttribute("preventDefault")||r.hasAttribute("gt-false"))&&t.preventDefault()}return n})}r=r.parentElement}findAll(".gt-active").forEach(i=>{i.classList.remove("gt-active"),void 0!==i.touchInfo&&void 0!==i.touchInfo.moveHandler&&(e.removeEventListener("touchmove",i.touchInfo.moveHandler),e.removeEventListener("mousemove",i.touchInfo.moveHandler),this.handleEvent("dragend",t,i)),delete i.touchInfo}),this.longPressIntervals.list.forEach(t=>clearInterval(t)),this.longPressIntervals.clear()}executeAction(t,e,i,n){let r=!0,s=e.getAttribute(i);try{r="[fn]"===s&&i+"-fn"in e?e[i+"-fn"](t,e,n):new Function("event","target","touch",s).bind(e)(t,e,n)}catch(t){throw name+" event function error on element '"+e.id+"'\n"+t.toString()}return r}handleEvent(t,e,i){let n=t,r=!0;return i&&(r=this.executeAction(e,i,n,i.touchInfo),t in this.upEvents&&(i.classList.remove("gt-active"),this.longPressIntervals.has(i.touchInfo.index)&&clearInterval(this.longPressIntervals.get(i.touchInfo.index)),delete i.touchInfo)),r}on(t,e,i){t.setAttribute(e,"[fn]"),t[e+"-fn"]=i}off(t,e){t.removeAttribute(e+"-action"),delete t[e+"-fn"]}hideKeyboard(){let t=document.createElement("input");t.setAttribute("type","text"),document.body.appendChild(t),setTimeout(function(){t.focus(),setTimeout(function(){t.setAttribute("style","display:none;"),t.parentElement.removeChild(t)},50)},50)}hasTouchEvent(){return"ontouchstart"in document.documentElement}outside(){this.triggerOutside(this.root,new FocusEvent("")),this.hideKeyboard()}}function init$2(t){return new GoodTap(t)}export{GoodTap,init$2 as init};
//# sourceMappingURL=goodtap.es6.min.js.map
